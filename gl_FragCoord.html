<html>
<head>
<title>WebGL gl_FragCoord test</title>
<style> 
body { font-family:arial }
h2 { margin:0 }
div { float:left; margin:0 2em 0 0 }
</style>
</head>

<body>
<h1>WebGL gl_FragCoord test</h1>

<div>
    <h2>WebGL rendering</h2>
    <canvas width="256px" height="256px" id="gl"></canvas>
</div>    

<br style="clear:both"/>


<script>
function createRectangle(size, data) {
    var half = size/2;
    var z1 = 1.0, z2 = 100.0;
    
    data.vertices = [ 
        -half, -half, z1,
        half, -half, z1,
        half, half, z2,
        -half, half, z2
    ];
    
    data.indices = [
        2,1,0,
        0,3,2
    ];
}

function initObject(gl) {
    
    var data = {
        'vertices':[],
        'indices' :[]
    }
    createRectangle(15, data);
    
    var object = {};
    
    object["vertex_buffer"] = gl.createBuffer();  
    gl.bindBuffer(gl.ARRAY_BUFFER, object["vertex_buffer"]);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(data["vertices"]), gl.STATIC_DRAW);

    object["index_buffer"] = gl.createBuffer();
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, object["index_buffer"]);
    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array(data["indices"]), gl.STATIC_DRAW); 

    object["n_elements"] = data.indices.length;
    
    return object;
}

function initShader(gl) {
    var vs  = "attribute vec3 aVertexPosition;";
        vs += "uniform mat4 uModelViewMatrix;";
        vs += "uniform mat4 uProjectionMatrix;";
        vs += "void main(void) {";
        vs +=   "gl_Position = uProjectionMatrix * uModelViewMatrix * vec4(aVertexPosition, 1.0);";
        vs += "}";

    var fs  = "#ifdef GL_ES \n";
        fs += "precision highp float; \n";
        fs += "#endif \n";
        fs += "const float LOG2 = 1.442695;\n";
        fs += "";
        fs += "";
        fs += "";
        fs += "void main(void) {";
        fs +=   "float density = 0.02;\n";
        fs +=   "float z = (gl_FragCoord.z / gl_FragCoord.w);";
        fs +=   "float fogFactor = exp2(-density * density * z * z * LOG2);";
        fs +=   "fogFactor = clamp(fogFactor, 0.0, 1.0);";
        fs +=   "gl_FragColor = vec4(1, 1, 1, fogFactor);";
        fs += "}";

    var xfs = gl.createShader(gl.FRAGMENT_SHADER);
    gl.shaderSource(xfs, fs);
    gl.compileShader(xfs);
        
    // See if it compiled successfully
    if(!gl.getShaderParameter(xfs, gl.COMPILE_STATUS)) {
        alert("An error occurred compiling the shaders: " + gl.getShaderInfoLog(xfs));
        return null;
    }
    
    var xvs = gl.createShader(gl.VERTEX_SHADER);
    gl.shaderSource(xvs, vs);
    gl.compileShader(xvs);

    // See if it compiled successfully
    if(!gl.getShaderParameter(xvs, gl.COMPILE_STATUS)) {
        alert("An error occurred compiling the shaders: " + gl.getShaderInfoLog(xvs));
        return null;
    }
    
    var shader = {};
    
    shader["program"] = gl.createProgram();
    gl.attachShader(shader["program"], xvs);
    gl.attachShader(shader["program"], xfs);
    gl.linkProgram(shader["program"]);

    // See if it compiled successfully
    if(!gl.getProgramParameter(shader["program"], gl.LINK_STATUS)) {
        alert("Unable to initialize the shader program.");
        return null;
    }

    gl.useProgram(shader["program"]);
    shader["aVertexPosition"] = gl.getAttribLocation(shader["program"], "aVertexPosition");
    gl.enableVertexAttribArray(shader["aVertexPosition"]);
    
    shader["uModelViewMatrix"] = gl.getUniformLocation(shader["program"], "uModelViewMatrix");
    shader["uProjectionMatrix"] = gl.getUniformLocation(shader["program"], "uProjectionMatrix");
    
        
    shader["MV_MATRIX"] = [ 1.0, 0.0, 0.0, 0.0,
                            0.0, 1.0, 0.0, 0.0,
                            0.0, 0.0, 1.0, 0.0,
                            0.0, 0.0, 0.0, 1.0 ];
    
    // perspective
    // near:1, far:100, fov: 45, aspect: 1
    // position: 0,0,10
    // target: 0,0,0
    shader["PROJECTION_MATRIX"] = [
                          2.414213562373095, 0, 0, 0,
                          0, 2.414213562373095, 0, 0,
                          0, 0, -1.02020202020202, 8.18181818181818,
                          0, 0, -1, 10 ];
    return shader;
}

function checkError(text, gl) {
    var error = gl.getError();
    if (error != gl.NO_ERROR) {
        alert(text+" "+error);
    }
}

function drawObject(gl, shader, object) {
    gl.useProgram(shader["program"]);
            
    gl.bindBuffer(gl.ARRAY_BUFFER, object["vertex_buffer"]);
    gl.vertexAttribPointer(shader["aVertexPosition"], 3, gl.FLOAT, false, 0, 0);
    
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, object["index_buffer"]);
    
    gl.uniformMatrix4fv(shader["uProjectionMatrix"], false, shader["PROJECTION_MATRIX"]);
    gl.uniformMatrix4fv(shader["uModelViewMatrix"], false, shader["MV_MATRIX"]);
    
    gl.drawElements(gl.TRIANGLES, object["n_elements"], gl.UNSIGNED_SHORT, 0);
}

function renderFrame(gl, shader, object) {
    gl.clearColor(0.0, 0.0, 0.0, 1.0);
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
    drawObject(gl, shader, object);
}

function init() {
    var canvas = document.getElementById("gl");
    var gl = canvas.getContext("experimental-webgl");

    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
    gl.enable(gl.BLEND);
    gl.disable(gl.DEPTH_TEST);

    var shader = initShader(gl);
    var object = initObject(gl);
    renderFrame(gl, shader, object);
}

init();
</script>

</body>
</html>